<div class="main-container">
  <div class="planner-actions">
    <div class="user-label">
      <span class="user-name">{{ getUserDisplayName() }}</span>
    </div>
    <div class="spacer"></div>
    <div class="actions-right">
      <button mat-stroked-button color="accent" (click)="openAIDialog()" matTooltip="Generar plan con IA">
        <mat-icon>psychology</mat-icon>
        Generar plan
      </button>
      <button mat-raised-button color="primary" (click)="submitPlan()" matTooltip="Guardar el plan actual">
        <mat-icon>save</mat-icon>
        Guardar plan
      </button>
    </div>
  </div>
  <div class="ai-overlay" *ngIf="isGenerating" role="dialog" aria-live="assertive" aria-label="Generando plan con IA">
    <div class="ai-overlay-content">
      <div class="ai-animation-container">
        <div class="ai-brain-icon">
          <mat-icon class="brain-icon">psychology</mat-icon>
          <div class="thinking-dots">
            <span class="dot dot-1"></span>
            <span class="dot dot-2"></span>
            <span class="dot dot-3"></span>
          </div>
        </div>
        <div class="ai-dumbbell-icon">
          <mat-icon class="dumbbell-icon">fitness_center</mat-icon>
        </div>
      </div>
      <div class="ai-msg" [attr.aria-live]="generationStep ? 'polite' : null">
        {{ generationStep || 'Estamos creando tu plan de entrenamiento con IA...' }}
      </div>
      <div class="ai-subtitle">Esto puede tomar unos momentos</div>
      <div class="ai-progress-container">
        <mat-progress-bar mode="indeterminate" color="primary" class="ai-progress-bar"></mat-progress-bar>
      </div>
    </div>
  </div>
  <form [formGroup]="form" class="planner-header">
    <ng-container *ngIf="canAssignUser && !isSpecificUser">
      <mat-form-field appearance="outline">
        <mat-label>Cliente</mat-label>
        <mat-select formControlName="targetUserId">
          <mat-option [value]="">Sin asignar</mat-option>
          <mat-option *ngFor="let u of clients" [value]="u.id">
            {{ u.givenName || '' }} {{ u.familyName || '' }} ({{ u.email }})
          </mat-option>
        </mat-select>
      </mat-form-field>
    </ng-container>
    <mat-form-field appearance="outline">
      <mat-label>Objetivo</mat-label>
      <textarea
        matInput
        formControlName="objective"
        placeholder="Describe el objetivo del cliente (ej: ganar masa muscular, perder peso, mejorar resistencia...)"
        rows="2"
      ></textarea>
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>Fecha</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="date"/>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>Sesiones</mat-label>
      <input matInput type="number" formControlName="sessionCount" min="1"/>
    </mat-form-field>

    <!-- ➤ Nuevo campo para las notas generales -->
    <mat-form-field appearance="outline">
      <mat-label>Notas generales</mat-label>
      <textarea
        matInput
        formControlName="notes"
        placeholder="Descripción, objetivos o comentarios para todo el plan"
        rows="2"
      ></textarea>
    </mat-form-field>
  </form>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-row">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar por nombre</mat-label>
        <input matInput [(ngModel)]="currentFilters.searchValue" (keyup)="onFilterChange()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Categoría</mat-label>
        <mat-select [(ngModel)]="currentFilters.categoryFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todas</mat-option>
          <mat-option *ngFor="let cat of filterOptions.categoryOptions" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Grupo Muscular</mat-label>
        <mat-select [(ngModel)]="currentFilters.muscleGroupFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let mg of filterOptions.muscleGroupOptions" [value]="mg">{{ mg }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de Equipo</mat-label>
        <mat-select [(ngModel)]="currentFilters.equipmentTypeFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let et of filterOptions.equipmentTypeOptions" [value]="et">{{ et }}</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="action-buttons">
        <button mat-raised-button color="primary" class="clear-filters" (click)="clearFilters()">
          <mat-icon>filter_alt_off</mat-icon>
          Limpiar filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="planner-body">
    <div class="visually-hidden" aria-live="polite">{{ liveMessage }}</div>
    <!-- Columna izquierda: Ejercicios y Planes anteriores -->
    <div class="left-column">
      <!-- Sidebar de ejercicios -->
      <aside class="exercise-sidebar">
        <h3>Ejercicios</h3>

        <!-- Submenú: a qué día agregar -->
        <mat-menu #addMenu="matMenu">
          <button mat-menu-item *ngFor="let s of sessions; trackBy: trackBySession" (click)="addExerciseToSession(s, menuExercise!)" [disabled]="!menuExercise">
            <mat-icon>add</mat-icon>
            <span>{{ s.name }}</span>
          </button>
        </mat-menu>

        <div cdkDropList id="exerciseList" [cdkDropListData]="filteredExercises" [cdkDropListConnectedTo]="exerciseListConnectedTo" class="list" (cdkDropListDropped)="drop($event)">
          <div class="empty" *ngIf="filteredExercises.length === 0">No hay resultados</div>
          <cdk-virtual-scroll-viewport itemSize="44" class="vs">
          <div *cdkVirtualFor="let ex of filteredExercises; trackBy: trackByExercise"
                 cdkDrag [cdkDragData]="ex" class="list-item" (cdkDragMoved)="onDragMoved($event)">
              <div class="exercise-name">
                {{ ex.name_es || ex.name }}
              </div>
              <div class="aliases">{{ ex.aliases ? ex.aliases.join(', ') : '' }}</div>
              <div class="row">
                <small>({{ ex.equipment_type || ex.equipment || 'Sin equipo' }})</small>
                <div class="actions">
                  <button mat-icon-button (click)="openExercisePreview(ex)" [matTooltip]="'Vista previa'">
                    <mat-icon>play_circle</mat-icon>
                  </button>
                  <button mat-icon-button (click)="toggleFavorite(ex)" [matTooltip]="'Favorito'">
                    <mat-icon>{{ isFavorite(ex) ? 'star' : 'star_border' }}</mat-icon>
                  </button>
                  <button mat-icon-button [matMenuTriggerFor]="addMenu" (click)="onOpenAddMenu(ex); $event.stopPropagation()" [matTooltip]="'Añadir a sesión'">
                    <mat-icon>playlist_add</mat-icon>
                  </button>
                </div>
              </div>
              <ng-container *cdkDragPreview>
                <div class="drag-preview">
                  <mat-icon>fitness_center</mat-icon>
                  {{ ex.name }}
                </div>
              </ng-container>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>

      </aside>

      <!-- Planes anteriores -->
      <div class="previous-plans-section">
        <h3>Planes anteriores</h3>
        <div class="list" *ngIf="previousPlans.length > 0; else noPreviousPlans">
          <div class="empty" *ngIf="previousPlans.length === 0">No hay planes anteriores</div>
          <cdk-virtual-scroll-viewport itemSize="60" class="vs-plans">
            <div *cdkVirtualFor="let plan of previousPlans; let i = index; trackBy: trackByPlan"
                 class="plan-item" (click)="openPlanPreview(plan)">
              <div class="plan-number">{{ i + 1 }}</div>
              <div class="plan-content">
                <div class="plan-date">{{ plan.date | date:'dd/MM/yyyy' }}</div>
                <div class="plan-sessions">{{ plan.sessions?.length || 0 }} sesiones</div>
              </div>
              <div class="plan-arrow">
                <mat-icon>chevron_right</mat-icon>
              </div>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>
        <ng-template #noPreviousPlans>
          <div class="empty">No hay planes anteriores</div>
        </ng-template>
      </div>
    </div>

    <!-- Sesiones verticales (drag & drop de sesiones) -->
    <section
      class="sessions"
      cdkDropList
      [cdkDropListData]="sessions"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="dropSession($event)"
    >
      <mat-card
        *ngFor="let s of sessions; trackBy: trackBySession"
        class="session-card"
        cdkDrag
        [cdkDragData]="s"
      >
        <div
          cdkDropList
          [id]="'session-' + s.id"
          [cdkDropListData]="s.items"
          [cdkDropListConnectedTo]="sessionsConnectedTo['session-' + s.id]"
          (cdkDropListDropped)="drop($event, s)"
        >
          <mat-card-header class="name-cursor">
            <mat-card-title>{{ s.name }}</mat-card-title>
            <div class="session-actions">
              <button mat-icon-button (click)="toggleCollapse(s)" [matTooltip]="s.collapsed ? 'Expandir' : 'Colapsar'">
                <mat-icon>{{ s.collapsed ? 'unfold_more' : 'unfold_less' }}</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content *ngIf="!s.collapsed">
            <table mat-table [dataSource]="s.items" class="session-table">
              <!-- Checkbox-->
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon class="superserie-header-icon"
                            [ngClass]="{'superserie-header-icon-active': hasSelectedItems(s)}"
                            (click)="groupSelected(s)"
                            [style.cursor]="hasSelectedItems(s) ? 'pointer' : 'not-allowed'"
                            [style.opacity]="hasSelectedItems(s) ? '1' : '0.4'"
                            matTooltip="Crear superserie (selecciona al menos 2 ejercicios)">link</mat-icon>
                </th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    <mat-checkbox
                      [(ngModel)]="item.selected"
                      (change)="updateSelection(s)"
                    ></mat-checkbox>
                  </ng-container>
                  <ng-container *ngIf="item.isGroup">
                    <span class="superset-label">Superserie</span>
                    <div class="group-actions">
                      <button
                        mat-icon-button
                        class="unlink-action"
                        (click)="ungroupGroup(s, i)"
                        matTooltip="Desagrupar superserie"
                      >
                        <mat-icon>link_off</mat-icon>
                      </button>
                    </div>
                  </ng-container>
                </td>
              </ng-container>


                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Ejercicio</th>
                  <td mat-cell *matCellDef="let item; let i = index" class="name-cell">
                    <ng-container *ngIf="!item.isGroup">
                      <span class="exercise-name-text">{{ item.name_es || item.name }}</span>
                    </ng-container>
                <ng-container *ngIf="item.isGroup && item.children as children">
                    <ng-container *ngFor="let child of children; let cIdx = index; trackBy: trackByChild">
                    <div class="child-row" [ngClass]="{ 'with-divider': cIdx > 0 }">
                      <span class="exercise-name-text">{{ child.name_es || child.name }}</span>
                    </div>
                  </ng-container>
                </ng-container>

                  </td>
                </ng-container>
              <!-- Equipo -->
              <ng-container matColumnDef="equipment">
                <th mat-header-cell *matHeaderCellDef>Equipo</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    {{ item.equipment }}
                  </ng-container>
                  <ng-container *ngIf="item.isGroup && item.children as children">
                    <ng-container *ngFor="let child of children; let childIdx = index; trackBy: trackByChild">
                      <div class="superserie-child-row" [ngClass]="{ 'with-divider': childIdx > 0 }">
                        {{ child.equipment }}
                      </div>
                    </ng-container>
                  </ng-container>
                </td>
              </ng-container>

              <!-- Series -->
              <ng-container matColumnDef="sets">
                <th mat-header-cell *matHeaderCellDef>Sets</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    <input class="sets-input"
                      matInput
                      type="number"
                      [(ngModel)]="item.sets"
                      (blur)="persist()"
                    />
                  </ng-container>
                  <ng-container *ngIf="item.isGroup && item.children as children">
                    <ng-container *ngFor="let child of children; let childIdx = index; trackBy: trackByChild">
                     <div class="superserie-child-row" [ngClass]="{ 'with-divider': childIdx > 0 }">
                        <input class="sets-input"
                          matInput
                          type="number"
                          [(ngModel)]="child.sets"
                          (blur)="persist()"
                        />
                      </div>
                    </ng-container>
                  </ng-container>
                </td>
              </ng-container>

              <!-- Reps -->
              <ng-container matColumnDef="reps">
                <th mat-header-cell *matHeaderCellDef>Reps</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    <input class="sets-input"
                      matInput
                      type="text"
                      [(ngModel)]="item.reps"
                      (blur)="persist()"
                    />
                  </ng-container>
                  <ng-container *ngIf="item.isGroup && item.children as children">
                    <ng-container *ngFor="let child of children; let childIdx = index; trackBy: trackByChild">
                     <div class="superserie-child-row" [ngClass]="{ 'with-divider': childIdx > 0 }">
                        <input class="sets-input"
                          matInput
                          type="text"
                          [(ngModel)]="child.reps"
                          (blur)="persist()"
                        />
                      </div>
                    </ng-container>
                  </ng-container>
                </td>
              </ng-container>

              <!-- Descanso -->
              <ng-container matColumnDef="rest">
                <th mat-header-cell *matHeaderCellDef>Rest</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    <input class="sets-input"
                      matInput
                      type="text"
                      [(ngModel)]="item.rest"
                      (blur)="persist()"
                    />
                  </ng-container>
                  <ng-container *ngIf="item.isGroup">
                    <ng-container *ngFor="let child of item.children; let childIdx = index">
                     <div class="superserie-child-row" [ngClass]="{ 'with-divider': childIdx > 0 }">
                        <input
                          matInput class="sets-input"
                          type="text"
                          [(ngModel)]="child.rest"
                          (blur)="persist()"
                        />
                      </div>
                    </ng-container>
                  </ng-container>
                </td>
              </ng-container>
              <!-- Columna Peso -->
            <ng-container matColumnDef="weight">
              <th mat-header-cell *matHeaderCellDef>Peso</th>
              <td mat-cell *matCellDef="let item; let i = index">

                <!-- 1) Ejercicio individual -->
                <ng-container *ngIf="!item.isGroup">
                  <input matInput class="sets-input"
                        type="text"
                        [(ngModel)]="item.weight"
                        (blur)="persist()" />
                </ng-container>

                <!-- 2) Superserie -->
                <ng-container *ngIf="item.isGroup && item.children as children">
                  <ng-container *ngFor="let child of children; let c = index; trackBy: trackByChild">
                    <div class="superserie-child-row"
                        [ngClass]="{ 'with-divider': c > 0 }">
                      <input matInput class="sets-input"
                            type="text"
                            [(ngModel)]="child.weight"
                            (blur)="persist()" />
                    </div>
                  </ng-container>
                </ng-container>

              </td>
            </ng-container>
              <!-- Acciones -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="!item.isGroup">
                    <button mat-icon-button (click)="openExercisePreview(item)" [matTooltip]="'Vista previa'">
                      <mat-icon>play_circle</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeItem(s, i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>
                  <ng-container *ngIf="item.isGroup && item.children as children">
                    <ng-container *ngFor="let child of children; let childIdx = index; trackBy: trackByChild">
                      <div class="superserie-child-row" [ngClass]="{ 'with-divider': childIdx > 0 }">
                        <button mat-icon-button (click)="openExercisePreview(child)" [matTooltip]="'Vista previa'">
                          <mat-icon>play_circle</mat-icon>
                        </button>
                      </div>
                    </ng-container>
                  </ng-container>
                </td>
              </ng-container>

              <!-- Eliminar Superserie -->
              <ng-container matColumnDef="superserieDelete">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <ng-container *ngIf="item.isGroup">
                    <button mat-icon-button color="warn" (click)="removeItem(s, i)" matTooltip="Eliminar superserie">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </ng-container>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['select', 'name', 'equipment', 'sets', 'reps', 'rest', 'weight', 'actions', 'superserieDelete']"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['select', 'name', 'equipment', 'sets', 'reps', 'rest', 'weight', 'actions', 'superserieDelete']"
                cdkDrag
                [cdkDragData]="row"
                [cdkDragDisabled]="row.isGroup && !canDragGroup(row)"
                (cdkDragMoved)="onDragMoved($event)"
                [ngClass]="{ 'superserie-group': row.isGroup }"
              ></tr>
            </table>
          </mat-card-content>
        </div>
      </mat-card>
    </section>



  </div>
</div>
