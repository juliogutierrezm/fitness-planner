<div class="main-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>style</mat-icon>
        Plantillas
      </mat-card-title>
      <mat-card-subtitle>Gesti√≥n de plantillas de entrenamiento reutilizables</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <div class="plans-actions">
    <button mat-fab extended color="primary" (click)="createTemplate()">
      <mat-icon>add</mat-icon>
      Crear plantilla nueva
    </button>
  </div>
  
  <mat-card class="plans-card">
    <div class="filters">
      <mat-form-field appearance="outline" class="q">
        <mat-label>Objetivo</mat-label>
        <input matInput [(ngModel)]="q" (ngModelChange)="applyFilters()" placeholder="Buscar objetivo o nombre" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="fromPicker" [(ngModel)]="dateFrom" (dateChange)="applyFilters()" />
        <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="toPicker" [(ngModel)]="dateTo" (dateChange)="applyFilters()" />
        <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>

      <button mat-button color="primary" (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Limpiar filtros
      </button>
    </div>

    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando plantillas...</p>
    </div>

    <div *ngIf="!loading && viewTemplates.length === 0" class="no-plans">
      <p>No hay plantillas que coincidan con el filtro.</p>
    </div>

    <mat-accordion class="plans-accordion" multi>
      <mat-expansion-panel *ngFor="let template of viewTemplates; trackBy: getPlanId">
        <mat-expansion-panel-header>
          <div class="plan-header">
            <div class="plan-main">
              <div class="plan-title">{{ getTemplateName(template) }}</div>
              <div class="plan-meta">
                <span class="meta-item">{{ template.date | date: 'dd/MM/yyyy' }}</span>
                <span class="meta-sep" aria-hidden="true">&middot;</span>
                <span class="meta-item">{{ getSessionCount(template) }} sesiones</span>
                <span class="objective-badge" *ngIf="template.objective">
                  <mat-icon>flag</mat-icon>
                  <span>{{ template.objective }}</span>
                </span>
              </div>
            </div>
            <div class="right">
              <button mat-mini-fab color="primary" [routerLink]="['/planner', getPlanId(template)]" matTooltip="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-mini-fab color="accent" (click)="assignTemplate(template)" matTooltip="Asignar a usuario">
                <mat-icon>person_add</mat-icon>
              </button>
              <div class="trash-icon">
              <button mat-mini-fab color="warn" (click)="deleteTemplate(getPlanId(template))" matTooltip="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
              </div>
            </div>
          </div>
        </mat-expansion-panel-header>

        <app-workout-plan-view [plan]="template"></app-workout-plan-view>
      </mat-expansion-panel>
    </mat-accordion>
  </mat-card>
</div>

<ng-template #userSelectDialog>
  <h2 mat-dialog-title>Asignar plantilla</h2>
  <mat-dialog-content>
    <div *ngIf="assignableUsers.length === 0" class="no-users">
      No hay usuarios disponibles.
    </div>
    <div *ngIf="assignableUsers.length > 0" class="dialog-search">
      <mat-form-field appearance="outline">
        <mat-label>Buscar usuario</mat-label>
        <input matInput [(ngModel)]="userSearch" (ngModelChange)="applyUserFilter()" placeholder="Nombre o email" />
      </mat-form-field>
    </div>
    <div *ngIf="assignableUsers.length > 0 && filteredAssignableUsers.length === 0" class="no-users">
      No hay usuarios que coincidan con el filtro.
    </div>
    <mat-list *ngIf="filteredAssignableUsers.length > 0">
      <div
        mat-list-item
        class="user-row"
        tabindex="0"
        *ngFor="let user of filteredAssignableUsers; trackBy: trackByUserId"
        (click)="selectUserForAssignment(user)"
        (keydown.enter)="selectUserForAssignment(user)"
        (keydown.space)="selectUserForAssignment(user)"
      >
        <div matLine>{{ user | userDisplayName }}</div>
        <div matLine class="secondary">{{ user.email }}</div>
      </div>
    </mat-list>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cerrar</button>
  </mat-dialog-actions>
</ng-template>
