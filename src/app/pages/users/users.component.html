<div class="users-page">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ isTrainerView ? 'sports' : 'group' }}</mat-icon>
        {{ pageTitle }}
      </mat-card-title>
      <mat-card-subtitle>{{ isTrainerView ? 'Administración de entrenadores y su rendimiento' : 'Gestión de clientes y planes asignados' }}</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <div *ngIf="canCreate && !showCreateForm" class="create-button-container">
    <button mat-raised-button color="primary" (click)="showCreateForm = true">
      <mat-icon>add</mat-icon>
      Crear nuevo {{ isTrainerView ? 'entrenador' : 'cliente' }}
    </button>
  </div>

  <mat-card class="form-card" *ngIf="canCreate && showCreateForm">
    <h3>Crear {{ isTrainerView ? 'entrenador' : 'cliente' }}</h3>
    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" type="email" required />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="givenName" required />
          <mat-error *ngIf="form.get('givenName')?.hasError('required')">
            El nombre es obligatorio
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Apellidos</mat-label>
          <input matInput formControlName="familyName" required />
          <mat-error *ngIf="form.get('familyName')?.hasError('required')">
            Los apellidos son obligatorios
          </mat-error>
        </mat-form-field>
        <!-- Campo Tel‚fono -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tel‚fono</mat-label>
          <input matInput formControlName="telephone" placeholder="+56912345678" type="tel">
        </mat-form-field>
        <!-- Campo G‚nero -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>G‚nero</mat-label>
          <mat-select formControlName="gender">
            <mat-option value="Masculino">Masculino</mat-option>
            <mat-option value="Femenino">Femenino</mat-option>
            <mat-option value="Otro">Otro</mat-option>
            <mat-option value="Prefiero no decirlo">Prefiero no decirlo</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Fecha de nacimiento</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="dateOfBirth" required>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="form.get('dateOfBirth')?.hasError('required')">
            La fecha de nacimiento es obligatoria
          </mat-error>
        </mat-form-field>
      </div>
      <div class="form-grid">
        <div class="injury-section">
          <mat-checkbox formControlName="noInjuries">Sin lesiones</mat-checkbox>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Lesiones o limitaciones</mat-label>
            <textarea matInput formControlName="injuries" rows="3" placeholder="Describe cualquier lesi¢n, limitaci¢n f¡sica o condici¢n m‚dica relevante"></textarea>
          </mat-form-field>
        </div>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notas internas</mat-label>
          <textarea matInput formControlName="notes" rows="2" placeholder="Notas privadas del entrenador"></textarea>
        </mat-form-field>
      </div>
      <div class="actions">
        <button mat-stroked-button type="button" (click)="showCreateForm = false">Cancelar</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || isSaving">Guardar</button>
      </div>
    </form>
  </mat-card>

  <mat-card class="list-card">
    <div *ngIf="isLoading" class="loading-container" role="status" aria-live="polite" aria-busy="true">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
    <div *ngIf="!isLoading && users.length === 0" class="empty">No hay usuarios</div>
    <ng-container *ngIf="!isLoading">
      <div class="user-row" *ngFor="let u of users">
      <ng-container *ngIf="editingId !== u.id; else editTpl">
        <div class="info">
          <div class="name">{{ u.givenName || '' }} {{ u.familyName || '' }}</div>
          <div class="meta">
            <span class="meta-item">{{ u.email }}</span>
            <span class="meta-sep" *ngIf="u.telephone">&middot;</span>
            <span class="meta-item" *ngIf="u.telephone">{{ u.telephone }}</span>
            <span class="meta-sep">&middot;</span>
            <span class="meta-item">{{ u.role }}</span>
            <span class="meta-sep" *ngIf="u.companyId && u.companyId !== 'INDEPENDENT'">&middot;</span>
            <span class="meta-item" *ngIf="u.companyId && u.companyId !== 'INDEPENDENT'">{{ u.companyId }}</span>
            <ng-container *ngIf="isTrainerView">
              <span class="meta-sep">&middot;</span>
              <span class="meta-item">Clientes: {{ getTrainerClientCount(u) }}</span>
              <span class="meta-sep">&middot;</span>
              <span class="meta-item">Planes: {{ getTrainerPlanCount(u) }}</span>
            </ng-container>
          </div>
          <div class="trainer-info" *ngIf="isClientView && isAdmin">
            <span class="trainer-label">Entrenador:</span>
            <span class="trainer-value">{{ getTrainerName(u) }}</span>
          </div>
          <div class="trainer-info" *ngIf="isTrainerView">
            <span class="trainer-label">Clientes:</span>
            <span class="trainer-value">{{ getTrainerClientSummary(u) }}</span>
          </div>
        </div>
        <div class="row-actions">
          <a *ngIf="isClientView" matTooltip="Ver planes" mat-icon-button [routerLink]="['/users', u.id]" [state]="{ user: u }" aria-label="Abrir detalle">
            <mat-icon>open_in_new</mat-icon>
          </a>
          <button *ngIf="isClientView && isAdmin" mat-icon-button (click)="assignTrainer(u)" aria-label="Asignar entrenador" matTooltip="Asignar entrenador">
            <mat-icon>person_add</mat-icon>
          </button>
          <button mat-icon-button (click)="startEdit(u)" aria-label="Editar" matTooltip="Editar usuario">
            <mat-icon>edit</mat-icon>
          </button>
          <button matTooltip="Eliminar usuario" mat-icon-button color="warn" (click)="remove(u)" aria-label="Eliminar">
            <mat-icon>delete</mat-icon>

          </button>
        </div>
      </ng-container>

      <ng-template #editTpl>
        <form [formGroup]="editForm" class="edit-grid" (ngSubmit)="saveEdit(u)">
          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" readonly />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="givenName" required />
            <mat-error *ngIf="editForm.get('givenName')?.hasError('required')">
              El nombre es obligatorio
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Apellidos</mat-label>
            <input matInput formControlName="familyName" required />
            <mat-error *ngIf="editForm.get('familyName')?.hasError('required')">
              Los apellidos son obligatorios
            </mat-error>
          </mat-form-field>
          <!-- Campo Tel‚fono -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tel‚fono</mat-label>
            <input matInput formControlName="telephone" placeholder="+56912345678" type="tel">
          </mat-form-field>
          <!-- Campo G‚nero -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>G‚nero</mat-label>
            <mat-select formControlName="gender">
              <mat-option value="Masculino">Masculino</mat-option>
              <mat-option value="Femenino">Femenino</mat-option>
              <mat-option value="Otro">Otro</mat-option>
              <mat-option value="Prefiero no decirlo">Prefiero no decirlo</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Fecha de nacimiento</mat-label>
            <input matInput [matDatepicker]="editPicker" formControlName="dateOfBirth" required>
            <mat-datepicker-toggle matSuffix [for]="editPicker"></mat-datepicker-toggle>
            <mat-datepicker #editPicker></mat-datepicker>
            <mat-error *ngIf="editForm.get('dateOfBirth')?.hasError('required')">
              La fecha de nacimiento es obligatoria
            </mat-error>
          </mat-form-field>
          <div class="injury-section">
            <mat-checkbox formControlName="noInjuries">Sin lesiones</mat-checkbox>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Lesiones o limitaciones</mat-label>
              <textarea matInput formControlName="injuries" rows="2" placeholder="Describe cualquier lesi¢n, limitaci¢n f¡sica o condici¢n m‚dica relevante"></textarea>
            </mat-form-field>
          </div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notas internas</mat-label>
            <textarea matInput formControlName="notes" rows="2" placeholder="Notas privadas del entrenador"></textarea>
          </mat-form-field>
          <div class="edit-actions">
            <button mat-stroked-button type="button" (click)="cancelEdit()">Cancelar</button>
            <button mat-raised-button color="primary" type="submit" [disabled]="editForm.invalid || isSaving">Guardar</button>
          </div>
        </form>
      </ng-template>
      </div>
    </ng-container>
  </mat-card>

  <!-- Trainer Assignment Dialog -->
  <ng-template #trainerSelectDialog>
    <h2 mat-dialog-title>Asignar Entrenador</h2>
    <mat-dialog-content>
      <p>Selecciona un entrenador para <strong>{{ selectedClientForAssignment?.givenName }} {{ selectedClientForAssignment?.familyName }}</strong>:</p>
      <mat-selection-list>
        <mat-list-option *ngFor="let trainer of getAvailableTrainers()" [value]="trainer" (click)="confirmAssignTrainer(trainer)">
          {{ trainer.givenName || '' }} {{ trainer.familyName || '' }} ({{ trainer.email }})
        </mat-list-option>
      </mat-selection-list>
      <div *ngIf="isAssigningTrainer" class="loading-container" role="status" aria-live="polite" aria-busy="true">
        <mat-spinner diameter="30"></mat-spinner>
        <span>Asignando...</span>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions>
      <button mat-button mat-dialog-close>Cancelar</button>
    </mat-dialog-actions>
  </ng-template>
</div>
