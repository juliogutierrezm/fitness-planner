<div class="main-container" [attr.aria-busy]="isSavingPlan || isSavingTemplate || isInitialLoading">
  <div
    class="planner-save-overlay"
    *ngIf="isSavingPlan || isSavingTemplate || isInitialLoading"
    role="status"
    aria-live="polite"
  >
    <div class="planner-save-content">
      <mat-progress-spinner mode="indeterminate" diameter="64"></mat-progress-spinner>
      <p class="planner-save-message">
        {{ isSavingPlan ? 'Guardando plan...' : isSavingTemplate ? 'Guardando plantilla...' : 'Cargando planificador...' }}
      </p>
    </div>
  </div>
  <div class="planner-actions">
    <div class="actions-left">
      <button mat-icon-button (click)="goBack()" matTooltip="Volver a la lista de planes">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>
    <div class="user-label">
      <span class="user-name">{{ getPlannerHeaderLabel() }}</span>
    </div>
    <div class="spacer"></div>
    <div class="actions-right">
      <ng-container *ngIf="!isEditMode">
        <mat-progress-spinner
          *ngIf="isUserLoading"
          mode="indeterminate"
          diameter="24"
        ></mat-progress-spinner>
        <button
          *ngIf="!isUserLoading"
          mat-stroked-button
          color="accent"
          (click)="openAIDialog()"
          [disabled]="!userProfile?.id"
          [matTooltip]="userProfile?.id ? 'Generar plan con IA' : 'Debe cargar un usuario antes de generar un plan con IA.'"
        >
          <mat-icon>psychology</mat-icon>
          Generar plan
        </button>
      </ng-container>
      <button
        *ngIf="!isTemplateMode"
        mat-stroked-button
        color="primary"
        (click)="openSaveTemplateDialog()"
        matTooltip="Guardar el plan actual como plantilla"
        [disabled]="isSavingPlan || isSavingTemplate || isInitialLoading"
      >
        <mat-icon>bookmark_add</mat-icon>
        Guardar como plantilla
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="submitPlan()"
        [matTooltip]="isTemplateMode ? (isEditMode ? 'Guardar cambios de plantilla' : 'Crear plantilla') : 'Guardar el plan actual'"
        [disabled]="isSavingPlan || isSavingTemplate || isInitialLoading || (isTemplateMode && form?.get('templateName')!.invalid)"
      >
        <mat-icon>save</mat-icon>
        {{ isTemplateMode ? (isEditMode ? 'Actualizar plantilla' : 'Crear plantilla') : (isEditMode ? 'Actualizar plan' : 'Crear plan') }}
      </button>
    </div>
  </div>

  <form [formGroup]="form" class="planner-header">
    <mat-form-field *ngIf="isTemplateMode" appearance="outline" class="field-template-name">
      <mat-label>Nombre de plantilla</mat-label>
      <input
        matInput
        formControlName="templateName"
        placeholder="Ej: Fuerza base"
        required
      />
      <mat-error *ngIf="form.get('templateName')!.hasError('required')">
        El nombre de la plantilla es obligatorio.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="field-objective">
      <mat-label>Objetivo</mat-label>
      <textarea
        matInput
        formControlName="objective"
        placeholder="Describe el objetivo del cliente (ej: ganar masa muscular, perder peso, mejorar resistencia...)"
        rows="2"
      ></textarea>
    </mat-form-field>

    <!-- âž¤ Nuevo campo para las notas generales -->
    <mat-form-field appearance="outline" class="field-notes">
      <mat-label>Notas generales</mat-label>
      <textarea
        matInput
        formControlName="notes"
        placeholder="DescripciÃ³n, objetivos o comentarios para todo el plan"
        rows="2"
      ></textarea>
    </mat-form-field>

    <div class="narrow-fields">
      <mat-form-field appearance="outline" class="field-date">
        <mat-label>Inicio del plan</mat-label>
        <input matInput [matDatepicker]="planDatePicker" formControlName="date" />
        <mat-datepicker-toggle matSuffix [for]="planDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #planDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="field-sessions">
        <mat-label>Sesiones</mat-label>
        <input matInput type="number" formControlName="sessionCount" min="1"/>
      </mat-form-field>
    </div>
  </form>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-header">
      <h3 class="filters-title">Filtro de ejercicios</h3>
      <button mat-raised-button color="primary" class="clear-filters" (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Limpiar filtros
      </button>
    </div>
    <div class="filters-row">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar por nombre</mat-label>
        <input matInput [(ngModel)]="currentFilters.searchValue" (keyup)="onFilterChange()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>CategorÃ­a</mat-label>
        <mat-select [(ngModel)]="currentFilters.categoryFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todas</mat-option>
          <mat-option *ngFor="let cat of filterOptions.categoryOptions" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Grupo Muscular</mat-label>
        <mat-select [(ngModel)]="currentFilters.muscleGroupFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let mg of filterOptions.muscleGroupOptions" [value]="mg">{{ mg }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de Equipo</mat-label>
        <mat-select [(ngModel)]="currentFilters.equipmentTypeFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let et of filterOptions.equipmentTypeOptions" [value]="et">{{ et }}</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="functional-filter">
        <mat-checkbox [(ngModel)]="currentFilters.functionalOnly" (change)="onFilterChange()">
          Solo funcionales
        </mat-checkbox>
      </div>
    </div>
  </div>



  <!-- Body -->
  <div class="planner-body">
    <div class="visually-hidden" aria-live="polite">{{ liveMessage }}</div>
    <!-- Columna izquierda: Ejercicios y Planes anteriores -->
    <div class="left-column">
      <!-- Sidebar de ejercicios -->
      <aside class="exercise-sidebar">
        <h3>Ejercicios</h3>

        <!-- SubmenÃº: a quÃ© dÃ­a agregar -->
        <mat-menu #addMenu="matMenu">
          <button mat-menu-item *ngFor="let s of sessions; trackBy: trackBySession" (click)="addExerciseToSession(s, menuExercise!)" [disabled]="!menuExercise">
            <mat-icon>add</mat-icon>
            <span>{{ s.name }}</span>
          </button>
        </mat-menu>

        <div cdkDropList id="exerciseList" [cdkDropListData]="filteredExercises" [cdkDropListConnectedTo]="exerciseListConnectedTo" class="list" (cdkDropListDropped)="drop($event)">
          <div class="empty" *ngIf="filteredExercises.length === 0">No hay resultados</div>
          <cdk-virtual-scroll-viewport itemSize="44" class="vs">
          <div *cdkVirtualFor="let ex of filteredExercises; trackBy: trackByExercise"
                 cdkDrag [cdkDragData]="ex" class="list-item" (cdkDragMoved)="onDragMoved($event)">
              <div class="exercise-name">
                {{ ex.name_es || 'Nombre no disponible' }}
              </div>
              <div class="aliases">{{ ex.aliases ? ex.aliases.join(', ') : '' }}</div>
              <div class="row">
                <small>({{ ex.equipment_type || 'Equipo no definido' }})</small>
                <div class="actions">
                  <button mat-icon-button (click)="openExercisePreview(ex)" [matTooltip]="'Vista previa'">
                    <mat-icon>play_circle</mat-icon>
                  </button>
                  <button mat-icon-button (click)="toggleFavorite(ex)" [matTooltip]="'Favorito'">
                    <mat-icon>{{ isFavorite(ex) ? 'star' : 'star_border' }}</mat-icon>
                  </button>
                  <button mat-icon-button [matMenuTriggerFor]="addMenu" (click)="onOpenAddMenu(ex); $event.stopPropagation()" [matTooltip]="'AÃ±adir a sesiÃ³n'">
                    <mat-icon>playlist_add</mat-icon>
                  </button>
                </div>
              </div>
              <ng-container *cdkDragPreview>
                <div class="drag-preview">
                  <mat-icon>fitness_center</mat-icon>
                  {{ ex.name_es || 'Nombre no disponible' }}
                </div>
              </ng-container>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>

      </aside>

      <!-- Planes anteriores -->
      <div class="previous-plans-section">
        <h3>Planes anteriores</h3>
        <div class="list" *ngIf="previousPlans.length > 0; else noPreviousPlans">
          <div class="empty" *ngIf="previousPlans.length === 0">No hay planes anteriores</div>
          <cdk-virtual-scroll-viewport itemSize="60" class="vs-plans">
            <div *cdkVirtualFor="let plan of previousPlans; let i = index; trackBy: trackByPlan"
                 class="plan-item" (click)="openPlanPreview(plan)">
              <div class="plan-content">
                <div class="plan-date">Plan {{ plan.planOrdinal }} - {{ plan.date | date:'dd/MM/yyyy' }}</div>
                <div class="plan-sessions">{{ plan.sessions?.length || 0 }} sesiones</div>
              </div>
              <div class="plan-arrow">
                <mat-icon>chevron_right</mat-icon>
              </div>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>
        <ng-template #noPreviousPlans>
          <div class="empty">No hay planes anteriores</div>
        </ng-template>
      </div>
    </div>

    <!-- Sesiones verticales (drag & drop de sesiones) -->
    <section
      class="sessions"
      cdkDropList
      [cdkDropListData]="sessions"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="dropSession($event)"
    >
      <mat-card
        *ngFor="let s of sessions; trackBy: trackBySession"
        class="session-card"
        cdkDrag
        [cdkDragData]="s"
      >
        <div
          cdkDropList
          [id]="'session-' + s.id"
          [cdkDropListData]="s.items"
          [cdkDropListConnectedTo]="sessionsConnectedTo['session-' + s.id]"
          (cdkDropListDropped)="drop($event, s)"
        >
          <mat-card-header class="name-cursor">
            <mat-card-title>{{ s.name }}</mat-card-title>
            <div class="session-actions">
              <button mat-icon-button (click)="toggleCollapse(s)" [matTooltip]="s.collapsed ? 'Expandir' : 'Colapsar'">
                <mat-icon>{{ s.collapsed ? 'unfold_more' : 'unfold_less' }}</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content *ngIf="!s.collapsed">
            <table class="mat-table session-table">
              <thead>
                <tr class="mat-header-row">
                  <th class="mat-header-cell">
                    <mat-icon class="superserie-header-icon"
                              [ngClass]="{'superserie-header-icon-active': hasSelectedItems(s)}"
                              (click)="groupSelected(s)"
                              [style.cursor]="hasSelectedItems(s) ? 'pointer' : 'not-allowed'"
                              [style.opacity]="hasSelectedItems(s) ? '1' : '0.4'"
                              matTooltip="Crear superserie (selecciona al menos 2 ejercicios)">link</mat-icon>
                  </th>
                  <th class="mat-header-cell">Ejercicio</th>
                  <th class="mat-header-cell">Equipo</th>
                  <th class="mat-header-cell">Sets</th>
                  <th class="mat-header-cell">Reps</th>
                  <th class="mat-header-cell">Rest</th>
                  <th class="mat-header-cell">Peso</th>
                  <th class="mat-header-cell">Acciones</th>
                  <th class="mat-header-cell"></th>
                </tr>
              </thead>

              <tbody>
                <ng-container *ngFor="let item of s.items; let i = index; trackBy: trackByItem">
                  <ng-container *ngIf="!item.isGroup">
                    <tr cdkDrag
                        [cdkDragData]="item"
                        (cdkDragMoved)="onDragMoved($event)">
                      <td class="mat-cell select-cell">
                        <mat-checkbox
                          [(ngModel)]="item.selected"
                          (change)="updateSelection(s)"
                        ></mat-checkbox>
                      </td>
                      <td class="mat-cell name-cell">
                        <span class="exercise-name-text" [matTooltip]="getDisplayName(item)">{{ getDisplayName(item) }}</span>
                      </td>
                      <td class="mat-cell">
                        {{ getEquipmentLabel(item) }}
                      </td>
                      <td class="mat-cell">
                        <input class="sets-input"
                          matInput
                          type="number"
                          [(ngModel)]="item.sets"
                          (blur)="persist()"
                        />
                      </td>
                      <td class="mat-cell">
                        <input class="sets-input"
                          matInput
                          type="text"
                          [(ngModel)]="item.reps"
                          (blur)="persist()"
                        />
                      </td>
                      <td class="mat-cell">
                        <input class="sets-input"
                          matInput
                          type="text"
                          [(ngModel)]="item.rest"
                          (blur)="persist()"
                        />
                      </td>
                      <td class="mat-cell">
                        <input matInput class="sets-input"
                              type="text"
                              [(ngModel)]="item.weight"
                              (blur)="persist()" />
                      </td>
                      <td class="mat-cell">
                        <button mat-icon-button (click)="openExercisePreview(item)" [matTooltip]="'Vista previa'">
                          <mat-icon>play_circle</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="removeItem(s, i)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                      <td class="mat-cell"></td>
                    </tr>
                  </ng-container>

                  <ng-container *ngIf="item.isGroup">
                    <!-- Superserie block rendered inline -->
                    <tr class="superserie-block-row">
                      <td colspan="9" class="superserie-block-cell">
                        <div class="superserie-block" cdkDrag [cdkDragData]="item" (cdkDragMoved)="onDragMoved($event)">
                          <div class="superserie-header">
                            <span class="superserie-label">ðŸ”— Superserie</span>
                            <div class="superserie-actions">
                              <button mat-icon-button color="warn" (click)="ungroupGroup(s, i)" matTooltip="Desagrupar superserie">
                                <mat-icon>link_off</mat-icon>
                              </button>
                              <button mat-icon-button color="warn" (click)="removeItem(s, i)" matTooltip="Eliminar superserie">
                                <mat-icon>delete</mat-icon>
                              </button>
                            </div>
                          </div>
                          <div class="superserie-body">
                            <table class="superserie-table">
                              <tbody>
                                <ng-container *ngFor="let child of item.children; let childIndex = index; trackBy: trackByChild">
                                <tr class="superserie-child-row">
                                    <td class="mat-cell select-cell">
                                      <!-- No checkbox for child rows -->
                                    </td>
                                    <td class="mat-cell name-cell">
                                      <span class="exercise-name-text" [matTooltip]="getDisplayName(child)">{{ getDisplayName(child) }}</span>
                                    </td>
                                    <td class="mat-cell">
                                      {{ getEquipmentLabel(child) }}
                                    </td>
                                    <td class="mat-cell">
                                      <input class="sets-input"
                                        matInput
                                        type="number"
                                        [(ngModel)]="child.sets"
                                        (blur)="persist()"
                                      />
                                    </td>
                                    <td class="mat-cell">
                                      <input class="sets-input"
                                        matInput
                                        type="text"
                                        [(ngModel)]="child.reps"
                                        (blur)="persist()"
                                      />
                                    </td>
                                    <td class="mat-cell">
                                      <input class="sets-input"
                                        matInput
                                        type="text"
                                        [(ngModel)]="child.rest"
                                        (blur)="persist()"
                                      />
                                    </td>
                                    <td class="mat-cell">
                                      <input matInput class="sets-input"
                                            type="text"
                                            [(ngModel)]="child.weight"
                                            (blur)="persist()" />
                                    </td>
                                    <td class="mat-cell">
                                      <button mat-icon-button (click)="openExercisePreview(child)" [matTooltip]="'Vista previa'">
                                        <mat-icon>play_circle</mat-icon>
                                      </button>
                                    </td>
                                    <td class="mat-cell">
                                      <!-- No delete action for child rows -->
                                    </td>
                                  </tr>
                                </ng-container>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
              </tbody>
            </table>
          </mat-card-content>
        </div>
      </mat-card>
    </section>



  </div>
</div>

<ng-template #saveTemplateDialog>
  <h2 mat-dialog-title>Guardar como plantilla</h2>
  <mat-dialog-content>
    <p>Asigna un nombre para identificar esta plantilla.</p>
    <mat-form-field appearance="outline" class="dialog-field">
      <mat-label>Nombre de la plantilla</mat-label>
      <input matInput [(ngModel)]="templateNameInput" />
    </mat-form-field>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close [disabled]="isSavingTemplate">Cancelar</button>
    <button
      mat-raised-button
      color="primary"
      (click)="confirmSaveTemplate()"
      [disabled]="!templateNameInput.trim() || isSavingTemplate"
    >
      Guardar
    </button>
  </mat-dialog-actions>
</ng-template>
