<div class="parametric-dialog-container">
  <div class="parametric-dialog-header">
    <div class="parametric-dialog-title">
      <mat-icon class="ai-icon">auto_awesome</mat-icon>
      <h2>Generar Plan Personalizado con IA</h2>
    </div>
    <div class="parametric-dialog-divider"></div>
  </div>

  <div class="parametric-dialog-content">
    <form [formGroup]="form" class="parametric-form">

      <!-- General Data Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Datos Generales
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Género</mat-label>
            <mat-select formControlName="gender">
              <mat-option *ngFor="let option of genderOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
            <mat-hint>Para adaptar recomendaciones específicas</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nivel de Experiencia</mat-label>
            <mat-select formControlName="difficulty">
              <mat-option *ngFor="let option of difficultyOptions" [value]="option.value">
                {{ option.desc }}
              </mat-option>
            </mat-select>
            <mat-hint>Selecciona tu nivel actual de entrenamiento</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Objetivo Principal</mat-label>
            <mat-select formControlName="trainingGoal">
              <mat-option *ngFor="let option of trainingGoalOptions" [value]="option.value">
                {{ option.desc }}
              </mat-option>
            </mat-select>
            <mat-hint>¿Qué quieres lograr con tu entrenamiento?</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Availability Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>schedule</mat-icon>
          Disponibilidad
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Número de sesiones</mat-label>
            <input matInput type="number" formControlName="totalSessions" min="1" max="8" step="1">
            <mat-hint>¿Cuántas sesiones quieres en tu plan? (1-8)</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Duración por sesión (minutos)</mat-label>
            <input matInput type="number" formControlName="sessionDuration" min="30" max="180" step="15">
            <mat-hint>Tiempo disponible por sesión de entrenamiento (30-180 min)</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Número esperado de ejercicios por sesión</mat-label>
            <input matInput type="number" formControlName="expectedExercisesPerSession" min="4" max="20">
            <mat-hint>4-20 ejercicios (influencia complejidad del plan)</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Preferences Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>filter_list</mat-icon>
          Filtros
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field equipment-field">
            <mat-label>Equipo disponible</mat-label>
            <mat-select formControlName="availableEquipment" multiple>
              <mat-option *ngFor="let equipment of equipmentOptions" [value]="equipment">
                {{ equipment }}
              </mat-option>
            </mat-select>
            <mat-hint>Selecciona todo el equipo que tienes disponible</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field muscle-field">
            <mat-label>Lesiones o restricciones</mat-label>
            <mat-select formControlName="excludeMuscles" multiple>
              <mat-option *ngFor="let muscle of muscleGroupOptions" [value]="muscle">
                {{ muscle }}
              </mat-option>
            </mat-select>
            <mat-hint>Grupos musculares a evitar (opcional)</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row preferences-row">
          <mat-checkbox formControlName="includeSupersets" class="supersets-checkbox">
            Incluir superseries
          </mat-checkbox>
          <span class="checkbox-hint">Optimiza el tiempo combinando ejercicios</span>
        </div>

        <div class="form-row preferences-row">
          <mat-checkbox formControlName="includeMobility" class="mobility-checkbox">
            Incluir ejercicios de movilidad
          </mat-checkbox>
          <span class="checkbox-hint">Mejora flexibilidad y preparación articular</span>
        </div>

        <div class="form-row preferences-row">
          <mat-checkbox formControlName="includeCardio" class="cardio-checkbox">
            Incluir ejercicios cardiovasculares
          </mat-checkbox>
          <span class="checkbox-hint">Mejora capacidad cardiovascular</span>
        </div>

        <div *ngIf="form.get('includeCardio')?.value" class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Ubicación del cardio</mat-label>
            <mat-select formControlName="cardioPlacement">
              <mat-option *ngFor="let option of cardioPlacementOptions" [value]="option.value">
                {{ option.desc }}
              </mat-option>
            </mat-select>
            <mat-hint>¿Dónde ubicar los ejercicios cardio?</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Duración del cardio (minutos)</mat-label>
            <input matInput type="number" formControlName="cardioDuration" min="5" max="30">
            <mat-hint>Tiempo dedicado a cardio por sesión</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Structure Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>view_list</mat-icon>
          Estructura del Plan
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Tipo de estructura</mat-label>
            <mat-select formControlName="planStructure">
              <mat-option *ngFor="let option of planStructureOptions" [value]="option.value">
                {{ option.desc }}
              </mat-option>
            </mat-select>
            <mat-hint>¿Cómo quieres organizar tus entrenamientos?</mat-hint>
          </mat-form-field>
        </div>

        <!-- Session Blueprint Section (shown only when "Personalizado" is selected) -->
        <div *ngIf="form.get('planStructure')?.value === 'Personalizado'" class="custom-structure-section">
          <h4 class="subsection-title">Configuración personalizada por sesión</h4>
          <p class="subsection-hint">Asigna nombre y grupos musculares a cada sesión de entrenamiento</p>

          <div class="custom-days-container">
            <div *ngFor="let sessionControl of getSessionBlueprintControls(); let i = index" class="custom-day-item">
              <mat-form-field appearance="outline" class="session-name-field">
                <mat-label>Nombre de la sesión {{ i + 1 }}</mat-label>
                <input matInput [formControl]="getSessionNameControl(i)">
              </mat-form-field>
              <mat-form-field appearance="outline" class="day-field">
                <mat-label>Grupos musculares</mat-label>
                <mat-select [formControl]="getSessionMuscleGroupsControl(i)" multiple>
                  <mat-option *ngFor="let muscle of muscleGroupOptions" [value]="muscle">
                    {{ muscle }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Notes Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>notes</mat-icon>
          Notas Adicionales
        </h3>

        <mat-form-field appearance="outline" class="notes-field">
          <mat-label>Preferencias específicas (opcional)</mat-label>
          <textarea
            matInput
            formControlName="customNotes"
            rows="2"
            maxlength="150"
            placeholder="Ej: Enfoque en fuerza máxima, evitar ejercicios de alto impacto, preferencia por ejercicios funcionales..."></textarea>
          <mat-hint>{{ (form.get('customNotes')?.value || '').length }}/150 caracteres</mat-hint>
        </mat-form-field>
      </div>

    </form>
  </div>

  <div class="parametric-dialog-actions">
    <button mat-stroked-button (click)="close()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      Cancelar
    </button>
    <button
      mat-raised-button
      color="primary"
      [disabled]="!isFormValid()"
      (click)="confirm()"
      class="generate-btn">
      <mat-icon *ngIf="!isGenerating">auto_awesome</mat-icon>
      <mat-spinner *ngIf="isGenerating" diameter="20" class="spinner"></mat-spinner>
      {{ isGenerating ? 'Generando Plan...' : 'Generar Plan' }}
    </button>
  </div>
</div>
