<div class="parametric-dialog-container">
  <div class="parametric-dialog-header">
    <div class="parametric-dialog-title">
      <mat-icon class="ai-icon">auto_awesome</mat-icon>
      <h2>Generar Plan Personalizado con IA</h2>
    </div>
    <div class="parametric-dialog-divider"></div>
  </div>

  <div class="parametric-dialog-content">
    <form [formGroup]="form" class="parametric-form">

      <!-- User Profile Section (if available) -->
      <div class="form-section" *ngIf="userProfile">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Perfil del Usuario
        </h3>
        <div class="user-profile-info">
          <div class="profile-row">
            <span class="profile-label">Nombre:</span>
            <span class="profile-value">{{ userProfile.givenName || '' }} {{ userProfile.familyName || '' }}</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Edad:</span>
            <span class="profile-value">{{ userAge !== null ? (userAge + ' años') : 'No especificada' }}</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Género:</span>
            <span class="profile-value">{{ userProfile.gender || 'No especificado' }}</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Estado de lesiones:</span>
            <span class="profile-value">{{ userProfile.injuries ? 'Con lesiones' : 'Sin lesiones' }}</span>
          </div>
          <div class="profile-row" *ngIf="userProfile.injuries">
            <span class="profile-label">Detalle:</span>
            <span class="profile-value">{{ userProfile.injuries }}</span>
          </div>
          <div class="profile-row" *ngIf="userProfile.notes">
            <span class="profile-label">Notas:</span>
            <span class="profile-value">{{ userProfile.notes }}</span>
          </div>
        </div>
        <p class="profile-hint">Esta información se utilizará automáticamente para generar un plan personalizado y seguro.</p>
      </div>

      <!-- General Data Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Datos Generales
        </h3>

        <div class="experience-field">
          <div class="experience-header">
            <div class="experience-title">
              <mat-icon>military_tech</mat-icon>
              <span>Nivel de Experiencia</span>
            </div>
            <p class="experience-subtitle">Define el nivel de exigencia y los ejercicios disponibles para la IA.</p>
          </div>

          <div class="experience-help">
            <mat-icon class="help-icon">info</mat-icon>
            <span>El nivel determina que ejercicios puede usar la IA. Si hay duda entre dos niveles, elige siempre el mas bajo.</span>
          </div>

          <mat-radio-group formControlName="difficulty" class="level-selector" aria-label="Nivel de experiencia">
            <mat-radio-button
              *ngFor="let option of difficultyOptions"
              [value]="option.value"
              class="level-card">
              <div class="level-card-content">
                <div class="level-card-header">
                  <span class="level-card-title">{{ option.title }}</span>
                  <span class="level-card-assignment">Asignacion: {{ option.value }}</span>
                </div>
                <p class="level-card-purpose">{{ option.purpose }}</p>
                <ul class="level-card-criteria">
                  <li *ngFor="let criterion of option.criteria">{{ criterion }}</li>
                </ul>
                <p class="level-card-action">{{ option.nextAction }}</p>
              </div>
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Objetivo Principal</mat-label>
            <mat-select formControlName="trainingGoal">
              <mat-option *ngFor="let option of trainingGoalOptions" [value]="option.value">
                {{ option.desc }}
              </mat-option>
            </mat-select>
            <mat-hint>Que quieres lograr con tu entrenamiento?</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Availability Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>schedule</mat-icon>
          Disponibilidad
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Duración por sesión (minutos)</mat-label>
            <input matInput type="number" formControlName="sessionDuration" min="15" max="180" step="5">
            <mat-hint>Tiempo disponible por sesión de entrenamiento (30-180 min)</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Número esperado de ejercicios por sesión</mat-label>
            <input matInput type="number" formControlName="expectedExercisesPerSession" min="4" max="20">
            <mat-hint>4-20 ejercicios (influencia complejidad del plan)</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Preferences Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>filter_list</mat-icon>
          Filtros
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field equipment-field">
            <mat-label>Equipo disponible</mat-label>
            <mat-select formControlName="availableEquipment" multiple>
              <mat-option *ngFor="let equipment of equipmentOptions" [value]="equipment">
                {{ equipment }}
              </mat-option>
            </mat-select>
            <mat-hint>Selecciona todo el equipo que tienes disponible</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row preferences-row">
          <mat-checkbox formControlName="includeSupersets" class="supersets-checkbox">
            Incluir superseries
          </mat-checkbox>
          <span class="checkbox-hint">Optimiza el tiempo combinando ejercicios</span>
        </div>

        <div class="form-row preferences-row">
          <mat-checkbox formControlName="includeMobility" class="mobility-checkbox">
            Incluir ejercicios de movilidad
          </mat-checkbox>
          <span class="checkbox-hint">Mejora flexibilidad y preparación articular</span>
        </div>
      </div>

      <!-- Session Blueprint Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>view_list</mat-icon>
          Configuración de Sesiones
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Número de sesiones</mat-label>
            <input matInput type="number" formControlName="totalSessions" min="1" max="8" step="1">
            <mat-hint>¿Cuántas sesiones quieres en tu plan? (1-8)</mat-hint>
          </mat-form-field>
        </div>

        <p class="subsection-hint">Asigna nombre y grupos musculares a cada sesión de entrenamiento. El cardio se puede seleccionar como un grupo muscular más.</p>

        <div class="custom-structure-section">
          <div class="custom-days-container">
            <div *ngFor="let sessionControl of getSessionBlueprintControls(); let i = index" class="custom-day-item">
              <div class="session-controls">
                <mat-form-field appearance="outline" class="session-name-field">
                  <mat-label>Nombre de la sesión {{ i + 1 }}</mat-label>
                  <input matInput [formControl]="getSessionNameControl(i)">
                </mat-form-field>
                <mat-form-field appearance="outline" class="day-field">
                  <mat-label>Grupo muscular o tipo de ejercicio</mat-label>
                  <mat-select [formControl]="getSessionTargetsControl(i)" multiple>
                    <mat-option *ngFor="let muscle of muscleGroupOptions" [value]="muscle">
                      {{ muscle }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="session-chips">
                <mat-chip-set class="muscle-chips">
                  <mat-chip *ngFor="let muscle of getSessionTargetsControl(i).value"
                            (removed)="removeTarget(i, muscle)">
                    {{ muscle }}
                    <button matChipRemove>
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Notes Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>notes</mat-icon>
          Notas Adicionales
        </h3>

        <mat-form-field appearance="outline" class="notes-field">
          <mat-label>Preferencias específicas (opcional)</mat-label>
          <textarea
            matInput
            formControlName="customNotes"
            rows="2"
            maxlength="150"
            placeholder="Ej: Enfoque en fuerza máxima, evitar ejercicios de alto impacto, preferencia por ejercicios funcionales..."></textarea>
          <mat-hint>{{ (form.get('customNotes')?.value || '').length }}/150 caracteres</mat-hint>
        </mat-form-field>
      </div>

    </form>
  </div>

  <div class="parametric-dialog-actions">
    <button mat-stroked-button (click)="close()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      Cancelar
    </button>
    <button
      mat-raised-button
      color="primary"
      [disabled]="!isFormValid()"
      (click)="confirm()"
      class="generate-btn">
      <mat-icon *ngIf="!isGenerating">auto_awesome</mat-icon>
      <mat-spinner *ngIf="isGenerating" diameter="20" class="spinner"></mat-spinner>
      {{ isGenerating ? 'Generando Plan...' : 'Generar Plan' }}
    </button>
  </div>
</div>
