<div *ngIf="plan" class="plan-container">
  <mat-card class="plan-card">
    <mat-card-title>{{ plan.templateName || plan.name }}</mat-card-title>
    <mat-card-subtitle>
      Fecha: {{ plan.date | date:'mediumDate' }}<br />
      <span *ngIf="plan.generalNotes">Notas generales: {{ plan.generalNotes }}</span>
    </mat-card-subtitle>

    <ng-container *ngIf="hasRenderableSessions; else noSessions">
      <div *ngFor="let session of sessions" class="session-block">
        <h3>{{ session.name }}</h3>

        <table class="session-table">
          <thead>
            <tr>
              <th>Ejercicio</th>
              <th>Equipo</th>
              <th>Sets</th>
              <th>Reps</th>
              <th>Rest</th>
              <th>Peso</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let item of session.items">
              <ng-container *ngIf="!item.isGroup; else supersetBlock">
                <tr class="session-row">
                  <td class="name-cell">
                    <span class="exercise-name" [matTooltip]="getDisplayName(item)">{{ getDisplayName(item) }}</span>
                    <div *ngIf="item.notes" class="notes">Notas: {{ item.notes }}</div>
                  </td>
                  <td>{{ getEquipmentLabel(item) }}</td>
                  <td>{{ item.sets }}</td>
                  <td>{{ item.reps }}</td>
                  <td>{{ item.rest }}</td>
                  <td>{{ item.weight || '-' }}</td>
                </tr>
              </ng-container>

              <ng-template #supersetBlock>
                <tr class="superset-header-row">
                  <td colspan="6">
                    <div class="superset-header">Superserie</div>
                  </td>
                </tr>
                <tr *ngFor="let child of item.children" class="session-row superset-row">
                  <td class="name-cell">
                    <span class="exercise-name" [matTooltip]="getDisplayName(child)">{{ getDisplayName(child) }}</span>
                    <div *ngIf="child.notes" class="notes">Notas: {{ child.notes }}</div>
                  </td>
                  <td>{{ getEquipmentLabel(child) }}</td>
                  <td>{{ child.sets }}</td>
                  <td>{{ child.reps }}</td>
                  <td>{{ child.rest }}</td>
                  <td>{{ child.weight || '-' }}</td>
                </tr>
              </ng-template>
            </ng-container>
          </tbody>
        </table>
      </div>
    </ng-container>
    <ng-template #noSessions>
      <div class="empty-plan">Plan sin sesiones renderizables.</div>
    </ng-template>

    <!-- Progressions Section (at the end) -->
    <div *ngIf="progressions?.showProgressions && progressions?.weeks?.length" class="progressions-section">
      <h4 class="progressions-title">
        <mat-icon>trending_up</mat-icon>
        Progresiones ({{ progressions!.totalWeeks }} semanas)
      </h4>
      <div class="progressions-list">
        <div *ngFor="let week of progressions!.weeks" class="progression-week">
          <div class="week-header">
            <strong>Semana {{ week.week }}</strong>
            <span *ngIf="week.title" class="week-title">- {{ week.title }}</span>
          </div>
          <div class="week-note">{{ week.note }}</div>
        </div>
      </div>
    </div>
  </mat-card>
</div>
