<div class="main-container" [attr.aria-busy]="isSavingPlan || isSavingTemplate || isInitialLoading">
  <div
    class="planner-save-overlay"
    *ngIf="isSavingPlan || isSavingTemplate || isInitialLoading"
    role="status"
    aria-live="polite"
  >
    <div class="planner-save-content">
      <mat-progress-spinner mode="indeterminate" diameter="64"></mat-progress-spinner>
      <p class="planner-save-message">
        {{ isSavingPlan ? 'Guardando plan...' : isSavingTemplate ? 'Guardando plantilla...' : 'Cargando planificador...' }}
      </p>
    </div>
  </div>
  
  <div class="arrow-back-button">
    <button mat-mini-fab (click)="goBack()" matTooltip="Volver a la lista de planes">
      <mat-icon>arrow_back</mat-icon>
    </button>
            <button
          *ngIf="!isTemplateMode"
          mat-fab extended
          color="primary"
          (click)="openSaveTemplateDialog()"
          matTooltip="Guardar el plan actual como plantilla"
          [disabled]="isSavingPlan || isSavingTemplate || isInitialLoading"
        >
          <mat-icon>style</mat-icon>
          Guardar como plantilla
        </button>
  </div>
    <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>person</mat-icon>
        {{ getPlannerHeaderLabel() }}
      </mat-card-title>
      <mat-card-subtitle>Puedes crear tus planes con IA</mat-card-subtitle>
      <div class="actions-right">
        <ng-container *ngIf="!isEditMode">
          <mat-progress-spinner
            *ngIf="isUserLoading"
            mode="indeterminate"
            diameter="24"
          ></mat-progress-spinner>
          <button class="ia-button"
            *ngIf="!isUserLoading && !isTemplateMode"
            mat-fab extended
            color="accent"
            (click)="openAIDialog()"
            [disabled]="!userProfile?.id"
            [matTooltip]="userProfile?.id ? 'Generar plan con IA' : 'Debe cargar un usuario antes de generar un plan con IA.'"
          >
          <mat-icon>auto_awesome</mat-icon>
            Generar plan IA
          </button>
        </ng-container>
        <button
          mat-fab extended
          color="primary"
          (click)="submitPlan()"
          [matTooltip]="isTemplateMode ? (isEditMode ? 'Guardar cambios de plantilla' : 'Crear plantilla') : 'Guardar el plan actual'"
          [disabled]="isSavingPlan || isSavingTemplate || isInitialLoading"
        >
          <mat-icon>{{ isTemplateMode ? (isEditMode ? 'style' : 'style') : (isEditMode ? 'list_alt' : 'list_alt') }}</mat-icon>
          {{ isTemplateMode ? (isEditMode ? 'Actualizar plantilla' : 'Crear plantilla') : (isEditMode ? 'Actualizar plan' : 'Crear plan') }}
        </button>
      </div>
    </mat-card-header>
  </mat-card>
    <div class="spacer"></div>
  

  <form [formGroup]="form" class="planner-header">
    <div class="header-group header-group-meta">
      <mat-form-field *ngIf="isTemplateMode" appearance="outline" class="field-template-name compact-field">
        <mat-label>Nombre de plantilla</mat-label>
        <input
          matInput
          formControlName="templateName"
          placeholder="Ej: Fuerza base"
          required
        />
        <mat-error *ngIf="form.get('templateName')!.hasError('required')">
          El nombre de la plantilla es obligatorio.
        </mat-error>
      </mat-form-field>
    </div>
    <div class="header-group header-group-text">
      <mat-form-field appearance="outline" class="field-objective compact-textarea">
        <mat-label>Objetivo</mat-label>
        <textarea
          matInput
          formControlName="objective"
          placeholder="Describe el objetivo del cliente (ej: ganar masa muscular, perder peso, mejorar resistencia...)"
          rows="1"
        ></textarea>
      </mat-form-field>

      <!-- ? Nuevo campo para las notas generales -->
      <mat-form-field appearance="outline" class="field-notes compact-textarea">
        <mat-label>Notas generales</mat-label>
        <textarea
          matInput
          formControlName="notes"
          placeholder="Descripcion, objetivos o comentarios para todo el plan"
          rows="1"
        ></textarea>
      </mat-form-field>
      <div class="header-meta-fields">
        <mat-form-field appearance="outline" class="field-date compact-field">
          <mat-label>Inicio del plan</mat-label>
          <input matInput [matDatepicker]="planDatePicker" formControlName="date" />
          <mat-datepicker-toggle matSuffix [for]="planDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #planDatePicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>
  </form>

  <mat-expansion-panel class="progressions-panel">
    <mat-expansion-panel-header>
      
      <mat-panel-title class="progression-title">
        <mat-icon>show_chart</mat-icon>
          Progresion semanal (guia)
      </mat-panel-title>
      <mat-panel-description>
        <mat-checkbox
          class="progressions-toggle"
          [checked]="progressions.showProgressions"
          (change)="onProgressionsToggle($event.checked)"
          (click)="$event.stopPropagation()"
          (keydown)="$event.stopPropagation()"
        >
          Mostrar progresiones al cliente
        </mat-checkbox>
      </mat-panel-description>
    </mat-expansion-panel-header>

    <ng-template matExpansionPanelContent>
      <div class="progressions-body">
        <div class="progressions-controls">
          <mat-form-field appearance="outline" class="compact-field progressions-total">
            <mat-label>Total de semanas</mat-label>
            <input
              matInput
              type="number"
              min="1"
              [(ngModel)]="progressions.totalWeeks"
              (ngModelChange)="onTotalWeeksChange($event)"
            />
          </mat-form-field>
          <span class="progressions-hint">Guia textual semanal (no afecta el plan base).</span>
        </div>

        <div class="progressions-weeks">
          <div class="progression-week" *ngFor="let week of progressions.weeks; trackBy: trackByProgressionWeek">
            <div class="week-header">
              <span class="week-label">Semana {{ week.week }}</span>
              <mat-form-field appearance="outline" class="compact-field week-title">
                <mat-label>Titulo (opcional)</mat-label>
                <input matInput [(ngModel)]="week.title" [placeholder]="getProgressionTitlePlaceholder(week.week)" />
              </mat-form-field>
            </div>
            <mat-form-field appearance="outline" class="week-note compact-textarea">
              <mat-label>Nota</mat-label>
              <textarea
                matInput
                rows="2"
                [(ngModel)]="week.note"
                [placeholder]="getProgressionNotePlaceholder(week.week)"
              ></textarea>
            </mat-form-field>
          </div>
        </div>
      </div>
    </ng-template>
  </mat-expansion-panel>

  <!-- Filtros y Sesiones -->
  <div class="filters-and-sessions-row">
    <div class="filters-section">
      <div class="filters-header">
        <h3 class="filters-title">Filtro de ejercicios</h3>
        <button mat-stroked-button color="primary" class="clear-filters" (click)="clearFilters()">
          <mat-icon>filter_alt_off</mat-icon>
          Limpiar filtros
        </button>
      </div>
      <div class="filters-row">
      <mat-form-field appearance="outline" class="search-field compact-field">
        <mat-label>Nombre</mat-label>
        <input matInput [(ngModel)]="currentFilters.searchValue" (keyup)="onFilterChange()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="compact-field">
        <mat-label>Categoría</mat-label>
        <mat-select [(ngModel)]="currentFilters.categoryFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todas</mat-option>
          <mat-option *ngFor="let cat of filterOptions.categoryOptions" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="compact-field">
        <mat-label>Grupo Muscular</mat-label>
        <mat-select [(ngModel)]="currentFilters.muscleGroupFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let mg of filterOptions.muscleGroupOptions" [value]="mg">{{ mg }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="compact-field">
        <mat-label>Tipo de Equipo</mat-label>
        <mat-select [(ngModel)]="currentFilters.equipmentTypeFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let et of filterOptions.equipmentTypeOptions" [value]="et">{{ et }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="compact-field">
        <mat-label>Dificultad</mat-label>
        <mat-select [(ngModel)]="currentFilters.difficultyFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todas</mat-option>
          <mat-option *ngFor="let diff of filterOptions.difficultyOptions" [value]="diff">{{ diff }}</mat-option>
        </mat-select>
      </mat-form-field>

<!--       <mat-form-field appearance="outline" class="compact-field">
        <mat-label>Tipo de Grupo</mat-label>
        <mat-select [(ngModel)]="currentFilters.groupTypeFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">Todos</mat-option>
          <mat-option *ngFor="let gt of filterOptions.groupTypeOptions" [value]="gt">{{ gt }}</mat-option>
        </mat-select>
      </mat-form-field> -->
    </div>
  </div>

  <!-- Campo de sesiones (compacto) -->
  <form [formGroup]="form" class="sessions-wrapper-inline">
    <mat-form-field appearance="outline" class="field-sessions-inline compact-field">
      <mat-label>Sesiones</mat-label>
      <input matInput type="number" formControlName="sessionCount" min="1"/>
      <mat-icon matSuffix>event_available</mat-icon>
    </mat-form-field>
  </form>
</div>



  <!-- Body -->
  <div class="planner-body">
    <div class="visually-hidden" aria-live="polite">{{ liveMessage }}</div>
    <!-- Columna izquierda: Ejercicios y Planes anteriores -->
    <div class="left-column">
      <!-- Sidebar de ejercicios -->
      <aside class="exercise-sidebar">
        <h3>
          <mat-icon>fitness_center</mat-icon>
          Ejercicios
        </h3>

        <!-- Submenú: a qué día agregar -->
        <mat-menu #addMenu="matMenu">
          <button mat-menu-item *ngFor="let s of sessions; trackBy: trackBySession" (click)="addExerciseToSession(s, menuExercise!)" [disabled]="!menuExercise">
            <mat-icon>add</mat-icon>
            <span>{{ s.name }}</span>
          </button>
        </mat-menu>

        <div cdkDropList id="exerciseList" [cdkDropListData]="filteredExercises" [cdkDropListConnectedTo]="exerciseListConnectedTo" class="list" (cdkDropListDropped)="drop($event)">
          <div class="empty" *ngIf="filteredExercises.length === 0">No hay resultados</div>
          <cdk-virtual-scroll-viewport itemSize="36" class="vs">
          <div *cdkVirtualFor="let ex of filteredExercises; trackBy: trackByExercise"
                 cdkDrag [cdkDragData]="ex" class="list-item" (cdkDragMoved)="onDragMoved($event)">
              <div class="exercise-name">
                {{ ex.name_es || 'Nombre no disponible' }}
              </div>
              <div class="row">
                <small>({{ ex.equipment_type || 'Equipo no definido' }})</small>
                <div class="actions">
                  <button mat-mini-fab 
                    (click)="openExercisePreview(ex)" 
                    (mouseenter)="onVideoHover(ex, $event)"
                    (mouseleave)="onVideoLeave()"
                    [matTooltip]="'Vista previa'">
                    <mat-icon>play_circle</mat-icon>
                  </button>
<!--                   <button mat-mini-fab (click)="toggleFavorite(ex)" [matTooltip]="'Favorito'">
                    <mat-icon>{{ isFavorite(ex) ? 'star' : 'star_border' }}</mat-icon>
                  </button> -->
                  <button mat-mini-fab [matMenuTriggerFor]="addMenu" (click)="onOpenAddMenu(ex); $event.stopPropagation()" [matTooltip]="'Añadir a sesión'">
                    <mat-icon>playlist_add</mat-icon>
                  </button>
                </div>
              </div>
              <ng-container *cdkDragPreview>
                <div class="drag-preview">
                  <mat-icon>fitness_center</mat-icon>
                  {{ ex.name_es || 'Nombre no disponible' }}
                </div>
              </ng-container>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>

      </aside>

      <!-- Planes anteriores -->
      <div class="previous-plans-section">
        <h3>Planes anteriores</h3>
        <div class="list" *ngIf="previousPlans.length > 0; else noPreviousPlans">
          <div class="empty" *ngIf="previousPlans.length === 0">No hay planes anteriores</div>
          <cdk-virtual-scroll-viewport itemSize="60" class="vs-plans">
            <div *cdkVirtualFor="let plan of previousPlans; let i = index; trackBy: trackByPlan"
                 class="plan-item" (click)="openPlanPreview(plan)">
              <div class="plan-content">
                <div class="plan-date">Plan {{ plan.planOrdinal }} - {{ plan.date | date:'dd/MM/yyyy' }}</div>
                <div class="plan-sessions">{{ plan.sessions?.length || 0 }} sesiones</div>
              </div>
              <div class="plan-arrow">
                <mat-icon>chevron_right</mat-icon>
              </div>
            </div>
          </cdk-virtual-scroll-viewport>
        </div>
        <ng-template #noPreviousPlans>
          <div class="empty">No hay planes anteriores</div>
        </ng-template>
      </div>
    </div>

    <!-- Sesiones verticales (drag & drop de sesiones) -->
    <section
      class="sessions"
      cdkDropList
      [cdkDropListData]="sessions"
      [cdkDropListConnectedTo]="[]"
      (cdkDropListDropped)="dropSession($event)"
    >
      <mat-card
        *ngFor="let s of sessions; trackBy: trackBySession"
        class="session-card"
        cdkDrag
        [cdkDragData]="s"
      >
        <div
          cdkDropList
          [id]="'session-' + s.id"
          [cdkDropListData]="s.items"
          [cdkDropListConnectedTo]="sessionsConnectedTo['session-' + s.id]"
          (cdkDropListDropped)="drop($event, s)"
        >
          <mat-card-header class="name-cursor">
            <mat-card-title>{{ s.name }}</mat-card-title>
            <div class="session-actions">
              <button mat-mini-fab (click)="toggleCollapse(s)" [matTooltip]="s.collapsed ? 'Expandir' : 'Colapsar'">
                <mat-icon>{{ s.collapsed ? 'unfold_more' : 'unfold_less' }}</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content *ngIf="!s.collapsed">
            <div class="planner-table">
              <div class="planner-grid planner-row header-row">
                <div class="planner-header-cell control-cell">
                  <mat-icon class="superserie-header-icon"
                            [ngClass]="{'superserie-header-icon-active': hasSelectedItems(s)}"
                            (click)="groupSelected(s)"
                            [style.cursor]="hasSelectedItems(s) ? 'pointer' : 'not-allowed'"
                            [style.opacity]="hasSelectedItems(s) ? '1' : '0.4'"
                            matTooltip="Crear superserie (selecciona al menos 2 ejercicios)">offline_bolt</mat-icon>
                </div>
                <div class="planner-header-cell name-cell">Ejercicio</div>
                <div class="planner-header-cell">Equipo</div>
                <div class="planner-header-cell sets-cell">Sets</div>
                <div class="planner-header-cell reps-cell">Reps</div>
                <div class="planner-header-cell rest-cell">Rest</div>
                <div class="planner-header-cell weight-cell">Peso</div>
                <div class="planner-header-cell actions-cell">Acciones</div>
              </div>

              <ng-container *ngFor="let item of s.items; let i = index; trackBy: trackByItem">
                <ng-container *ngIf="!item.isGroup">
                  <div class="planner-grid planner-row exercise-row"
                       cdkDrag
                       [cdkDragData]="item"
                       (cdkDragMoved)="onDragMoved($event)">
                    <div class="planner-cell control-cell">
                      <mat-checkbox
                        [(ngModel)]="item.selected"
                        (change)="updateSelection(s)"
                      ></mat-checkbox>
                    </div>
                    <div class="planner-cell name-cell">
                      <span class="exercise-name-text" [matTooltip]="getDisplayName(item)">{{ getDisplayName(item) }}</span>
                    </div>
                    <div class="planner-cell">
                      {{ getEquipmentLabel(item) }}
                    </div>
                    <div class="planner-cell sets-cell">
                      <input class="sets-input"
                        matInput
                        type="number"
                        [(ngModel)]="item.sets"
                        (blur)="persist()"
                      />
                    </div>
                    <div class="planner-cell reps-cell">
                      <input class="reps-input"
                        matInput
                        type="text"
                        [(ngModel)]="item.reps"
                        (blur)="persist()"
                      />
                    </div>
                    <div class="planner-cell rest-cell">
                      <input class="sets-input"
                        matInput
                        type="text"
                        [(ngModel)]="item.rest"
                        (blur)="persist()"
                      />
                    </div>
                    <div class="planner-cell weight-cell">
                      <input matInput class="sets-input"
                            type="text"
                            [(ngModel)]="item.weight"
                            (blur)="persist()" />
                    </div>
                    <div class="planner-cell actions-cell ">
                      <button mat-mini-fab 
                        (click)="openExercisePreview(item)" 
                        (mouseenter)="onVideoHover(item, $event)"
                        (mouseleave)="onVideoLeave()"
                        [matTooltip]="'Vista previa'">
                        <mat-icon>play_circle</mat-icon>
                      </button>
                      <div class="trash-icon">
                      <button  mat-mini-fab  (click)="removeItem(s, i)">
                        <mat-icon>delete</mat-icon>
                      </button></div>
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="item.isGroup">
                  <!-- Superserie block rendered inline -->
                  <div class="superserie-wrapper" cdkDrag [cdkDragData]="item" (cdkDragMoved)="onDragMoved($event)">
                    <div class="planner-grid planner-row superserie-header">
                      <div class="planner-cell control-cell trash-icon">
                        <button mat-mini-fab color="warn" (click)="ungroupGroup(s, i)" matTooltip="Desagrupar superserie">
                          <mat-icon>link_off</mat-icon>
                        </button>
                      </div>
                      <div class="planner-cell name-cell">
                        <!-- Empty for spacing -->
                      </div>
                      <div class="planner-cell">
                        <mat-icon>flash_on</mat-icon>
                        <span class="superserie-label">Superserie</span>
                      </div>
                      <div class="planner-cell sets-cell">
                        <!-- Empty for spacing -->
                      </div>
                      <div class="planner-cell reps-cell">
                        <!-- Empty for spacing -->
                      </div>
                      <div class="planner-cell rest-cell">
                        <!-- Empty for spacing -->
                      </div>
                      <div class="planner-cell weight-cell">
                        <!-- Empty for spacing -->
                      </div>
                      <div class="planner-cell actions-cell trash-icon">
                        <button mat-mini-fab color="warn" (click)="removeItem(s, i)" matTooltip="Eliminar superserie">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </div>
                    <ng-container *ngFor="let child of item.children; let childIndex = index; trackBy: trackByChild">
                      <div class="planner-grid planner-row superserie-child-row">
                        <div class="planner-cell control-cell">
                          <mat-icon class="superserie-child-indicator" matTooltip="Parte de una superserie">link</mat-icon>
                        </div>
                        <div class="planner-cell name-cell">
                          <span class="exercise-name-text" [matTooltip]="getDisplayName(child)">{{ getDisplayName(child) }}</span>
                        </div>
                        <div class="planner-cell">
                          {{ getEquipmentLabel(child) }}
                        </div>
                        <div class="planner-cell sets-cell">
                          <input class="sets-input"
                            matInput
                            type="number"
                            [(ngModel)]="child.sets"
                            (blur)="persist()"
                          />
                        </div>
                        <div class="planner-cell reps-cell">
                          <input class="reps-input"
                            matInput
                            type="text"
                            [(ngModel)]="child.reps"
                            (blur)="persist()"
                          />
                        </div>
                        <div class="planner-cell rest-cell">
                          <input class="sets-input"
                            matInput
                            type="text"
                            [(ngModel)]="child.rest"
                            (blur)="persist()"
                          />
                        </div>
                        <div class="planner-cell weight-cell">
                          <input matInput class="sets-input"
                                type="text"
                                [(ngModel)]="child.weight"
                                (blur)="persist()" />
                        </div>
                        <div class="planner-cell actions-cell">
                          <button mat-mini-fab 
                            (click)="openExercisePreview(child)" 
                            (mouseenter)="onVideoHover(child, $event)"
                            (mouseleave)="onVideoLeave()"
                            [matTooltip]="'Vista previa'">
                            <mat-icon>play_circle</mat-icon>
                          </button>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
              </ng-container>
            </div>
          </mat-card-content>
        </div>
      </mat-card>
    </section>



  </div>

  <!-- Hover Preview Overlay -->
  <div *ngIf="hoveredExercise"
       class="hover-preview"
       [style.left.px]="previewPosition.x"
       [style.top.px]="previewPosition.y">
    <img *ngIf="getPreviewUrl(hoveredExercise)"
         [src]="getPreviewUrl(hoveredExercise)"
         alt="Vista previa"
         class="preview-image"
         loading="lazy">
    <div *ngIf="!getPreviewUrl(hoveredExercise)" class="preview-fallback">
      Vista previa no disponible
    </div>
  </div>
</div>

<ng-template #saveTemplateDialog>
  <h2 mat-dialog-title>Guardar como plantilla</h2>
  <mat-dialog-content>
    <p>Asigna un nombre para identificar esta plantilla.</p>
    <mat-form-field appearance="outline" class="dialog-field">
      <mat-label>Nombre de la plantilla</mat-label>
      <input matInput [(ngModel)]="templateNameInput" />
    </mat-form-field>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-fab extended mat-dialog-close [disabled]="isSavingTemplate">Cancelar</button>
    <button
      mat-fab extended
      color="primary"
      (click)="confirmSaveTemplate()"
      [disabled]="isSavingTemplate"
    >
      Guardar
    </button>
  </mat-dialog-actions>
</ng-template>
