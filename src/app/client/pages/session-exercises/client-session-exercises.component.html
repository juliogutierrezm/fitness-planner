<div class="session-exercises-page">
  <header class="session-header">
    <button class="nav-back" type="button" (click)="goBack()" aria-label="Volver al plan" [disabled]="isLoading">
      <mat-icon aria-hidden="true">arrow_back</mat-icon>
    </button>
    <div class="session-header-text">
      <p class="session-eyebrow">{{ planTitle }}</p>
      <h1 class="session-title">{{ sessionTitle }}</h1>
      <p class="session-count">{{ exerciseCount }} ejercicios</p>
    </div>
  </header>

  <div
    class="session-loading"
    *ngIf="isLoading"
    role="status"
    aria-live="polite"
    [attr.aria-busy]="isLoading">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Cargando ejercicios...</p>
  </div>

  <section class="session-exercises-list" *ngIf="!isLoading && !sessionMissing">
    <ng-container *ngFor="let item of sessionItems; trackBy: trackBySessionItem">
      <article
        class="exercise-card liquid-card"
        *ngIf="item.kind === 'exercise' && item.exercise as exercise"
        role="button"
        tabindex="0"
        (click)="openExercise(item.flatIndex!)"
        (keydown)="onExerciseKeydown($event, item.flatIndex!)"
        [attr.aria-label]="getExerciseAriaLabel(exercise, item.flatIndex!)">
        <div class="exercise-thumb">
          <img
            *ngIf="hasThumbnail(exercise, item.flatIndex!); else thumbPlaceholder"
            [src]="exercise.thumbnail"
            [alt]="getExerciseTitle(exercise, item.flatIndex!)"
            (error)="onImageError(item.flatIndex!)" />
          <ng-template #thumbPlaceholder>
            <mat-icon aria-hidden="true">image</mat-icon>
          </ng-template>
        </div>

        <div class="exercise-info">
          <h3 class="exercise-name liquid-title">{{ getExerciseTitle(exercise, item.flatIndex!) }}</h3>
          <p class="exercise-program liquid-subtitle">{{ getProgrammingLine(exercise) }}</p>
          <div class="exercise-tags" *ngIf="getExerciseMuscleLabel(exercise) || exercise.functional">
            <span class="exercise-tag liquid-meta" *ngIf="getExerciseMuscleLabel(exercise) as muscle">{{ muscle }}</span>
            <span class="exercise-tag liquid-meta" *ngIf="exercise.functional">Funcional</span>
          </div>
        </div>

        <mat-icon class="exercise-chevron" aria-hidden="true">chevron_right</mat-icon>
      </article>

      <section
        class="group-card liquid-card"
        *ngIf="item.kind === 'group' && item.group as group"
        aria-label="Grupo de ejercicios">
        <div class="group-header">
          <span class="group-badge liquid-meta">{{ item.label }}</span>
          <span class="group-name" *ngIf="group.name">{{ group.name }}</span>
        </div>
        <div class="group-children">
          <article
            class="exercise-card child-card"
            *ngFor="let child of item.children || []; trackBy: trackByGroupChild"
            role="button"
            tabindex="0"
            (click)="openExercise(child.flatIndex)"
            (keydown)="onExerciseKeydown($event, child.flatIndex)"
            [attr.aria-label]="getExerciseAriaLabel(child.exercise, child.flatIndex)">
            <div class="exercise-thumb">
              <img
                *ngIf="hasThumbnail(child.exercise, child.flatIndex); else childThumbPlaceholder"
                [src]="child.exercise.thumbnail"
                [alt]="getExerciseTitle(child.exercise, child.flatIndex)"
                (error)="onImageError(child.flatIndex)" />
              <ng-template #childThumbPlaceholder>
                <mat-icon aria-hidden="true">image</mat-icon>
              </ng-template>
            </div>

            <div class="exercise-info">
              <h3 class="exercise-name liquid-title">{{ getExerciseTitle(child.exercise, child.flatIndex) }}</h3>
              <p class="exercise-program liquid-subtitle">{{ getProgrammingLine(child.exercise) }}</p>
              <div class="exercise-tags" *ngIf="getExerciseMuscleLabel(child.exercise) || child.exercise.functional">
                <span class="exercise-tag liquid-meta" *ngIf="getExerciseMuscleLabel(child.exercise) as muscle">{{ muscle }}</span>
                <span class="exercise-tag liquid-meta" *ngIf="child.exercise.functional">Funcional</span>
              </div>
            </div>

            <mat-icon class="exercise-chevron" aria-hidden="true">chevron_right</mat-icon>
          </article>
        </div>
      </section>
    </ng-container>

    <div class="session-empty" *ngIf="!sessionItems.length">
      <mat-icon aria-hidden="true">fitness_center</mat-icon>
      <p>Esta sesion aun no tiene ejercicios.</p>
    </div>
  </section>

  <div class="session-missing" *ngIf="!isLoading && sessionMissing">
    <mat-icon aria-hidden="true">event_busy</mat-icon>
    <p>No encontramos esta sesion.</p>
    <button class="client-button" type="button" (click)="goBack()">Volver</button>
  </div>
</div>
