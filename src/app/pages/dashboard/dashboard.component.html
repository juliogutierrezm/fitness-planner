<div class="users-page" [@fadeInUp]>
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>dashboard</mat-icon>
        Dashboard operativo
      </mat-card-title>
      <mat-card-subtitle>
        Vista principal personalizada para tu contexto.
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <mat-card class="hero-card" [@fadeInUp]>
    <div class="hero-card__header">
      <div>
        <div class="hero-card__eyebrow">Panel operativo</div>
        <h1>Hola, {{ displayName }}</h1>
        <p class="hero-card__subtitle">Seguimiento inmediato de IA y operación diaria.</p>
      </div>
      <button mat-fab extended class="refresh-button" (click)="refresh()">
        <mat-icon>refresh</mat-icon>
        Actualizar
      </button>
    </div>
    <div class="hero-card__meta" *ngIf="vm$ | async as vm">
      <span class="hero-chip">
        <mat-icon>verified</mat-icon>
        {{ getModeLabel(vm.mode) }}
      </span>
      <span class="hero-chip" *ngIf="vm.aiPlanQuota; else noQuotaChip"
            [class.hero-chip--warn]="vm.aiPlanQuota.limitReached">
        <mat-icon>auto_awesome</mat-icon>
        Planes IA: {{ vm.aiPlanQuota.used }}/{{ vm.aiPlanQuota.limit }}
      </span>
      <ng-template #noQuotaChip>
        <span class="hero-chip">
          <mat-icon>auto_awesome</mat-icon>
          Planes IA este mes: {{ vm.aiPlansThisMonth }}
        </span>
      </ng-template>
      <span class="hero-chip">
        <mat-icon>bolt</mat-icon>
        Clientes con IA este mes: {{ vm.clientsWithAiThisMonth }}
      </span>
    </div>
  </mat-card>

  <section class="loading-container" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </section>

  <section class="error-card" *ngIf="!loading && error">
    <mat-icon>error_outline</mat-icon>
    <div>
      <p>No pudimos cargar el dashboard.</p>
      <span>Reintenta la actualización.</span>
    </div>
    <button mat-raised-button class="refresh-button" (click)="refresh()">Reintentar</button>
  </section>

  <ng-container *ngIf="!loading && !error && (vm$ | async) as vm">
    <section class="section" [@fadeInUp]>
      <div class="section-header">
        <h2>KPIs principales</h2>
        <span class="section-hint">Indicadores clave del mes.</span>
      </div>
      <div class="kpi-grid" [@listStagger]>
        <mat-card class="kpi-card" *ngFor="let kpi of vm.kpis; trackBy: trackByKpi">
          <div class="kpi-icon">
            <mat-icon>{{ kpi.icon }}</mat-icon>
          </div>
          <div class="kpi-info">
            <div class="kpi-value">{{ kpi.value }}</div>
            <div class="kpi-label">{{ kpi.label }}</div>
          </div>
        </mat-card>
      </div>
    </section>

    <section class="section" [@fadeInUp]>
      <div class="section-header">
        <h2>Actividad IA reciente</h2>
        <span class="section-hint">Últimos planes generados por IA.</span>
      </div>
      <mat-card class="list-card">
        <ng-container *ngIf="vm.recentAiActivity.length; else emptyActivity">
          <div class="user-row" *ngFor="let item of vm.recentAiActivity; trackBy: trackByActivity" [@fadeInUp]>
            <div class="info">
              <div class="name">{{ item.title }}</div>
              <div class="meta">
                <span>{{ item.subtitle }}</span>
                <span class="meta-sep">•</span>
                <span *ngIf="item.date">{{ item.date | date:'mediumDate' }}</span>
              </div>
            </div>
            <div class="row-actions">
              <button mat-raised-button color="primary" [routerLink]="['/ai-plans/user', item.clientId]">
                Ver historial IA
              </button>
            </div>
          </div>
        </ng-container>
        <ng-template #emptyActivity>
          <div class="activity-empty">
            <mat-icon>schedule</mat-icon>
            <div>
              <p>Sin actividad IA este mes.</p>
              <span>Genera planes desde la vista de clientes.</span>
            </div>
          </div>
        </ng-template>
      </mat-card>
    </section>

    <section class="section" [@fadeInUp]>
      <div class="section-header">
        <h2>Acciones rápidas</h2>
        <span class="section-hint">Accesos directos a vistas clave.</span>
      </div>
      <div class="quick-actions-grid" [@listStagger]>
        <a class="quick-action" *ngFor="let action of vm.quickActions; trackBy: trackByAction" [routerLink]="action.route">
          <div class="quick-action__icon">
            <mat-icon>{{ action.icon }}</mat-icon>
          </div>
          <div>
            <div class="quick-action__title">{{ action.label }}</div>
            <div class="quick-action__subtitle">{{ action.description }}</div>
          </div>
        </a>
      </div>
    </section>
  </ng-container>
</div>