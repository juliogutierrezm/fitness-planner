<div class="table-container">
    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 compact-table">

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let ex">
                <button mat-icon-button (click)="onViewDetails(ex)" matTooltip="Ver detalles">
                    <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button color="primary" (click)="onEditExercise(ex)" matTooltip="Editar ejercicio">
                    <mat-icon>edit</mat-icon>
                </button>
            </td>
        </ng-container>

        <!-- Video Preview Column -->
        <ng-container matColumnDef="preview_url">
            <th mat-header-cell *matHeaderCellDef>Video</th>
            <td mat-cell *matCellDef="let ex">
                <button
                  *ngIf="getFieldValue(ex, 'preview_url')"
                  mat-icon-button
                  (click)="onOpenVideo(ex)"
                  (mouseenter)="onVideoHover(ex, $event)"
                  (mouseleave)="onVideoLeave()"
                  attr.aria-label="Vista previa del video {{ getFieldValue(ex, 'name_es') }}">
                    <mat-icon>videocam</mat-icon>
                </button>
                <span *ngIf="!getFieldValue(ex, 'preview_url')" class="no-video">-</span>

                <!-- Hover Preview Overlay -->
                <div *ngIf="hoveredExercise && hoveredExercise.id === ex.id"
                     class="hover-preview"
                     [style.left.px]="previewPosition.x"
                     [style.top.px]="previewPosition.y">
                    <img *ngIf="getPreviewUrl(hoveredExercise)"
                         [src]="getPreviewUrl(hoveredExercise)"
                         alt="Vista previa"
                         class="preview-image"
                         loading="lazy">
                    <div *ngIf="!getPreviewUrl(hoveredExercise)" class="preview-fallback">
                        Vista previa no disponible
                    </div>
                </div>
            </td>
        </ng-container>

        <!-- Exercise Name Column -->
        <ng-container matColumnDef="name_es">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
            <td mat-cell *matCellDef="let ex">
                <div class="exercise-name-container">
                    <div class="exercise-name">{{ getFieldValue(ex, 'name_es') || '—' }}</div>
                    <div class="exercise-aliases-list" *ngIf="getAliasesOptions(ex).length > 0">
                        <span
                          class="exercise-alias-chip"
                          *ngFor="let alias of getAliasesOptions(ex)"
                          (click)="onAliasClick(ex, alias, $event)">
                          {{ alias }}
                        </span>
                    </div>
                </div>
            </td>
        </ng-container>

        <!-- Muscle Group Column -->
        <ng-container matColumnDef="muscle_group">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Grupo Muscular</th>
            <td mat-cell *matCellDef="let ex" matTooltip="{{ getFieldValue(ex, 'muscle_group') || '' }}">
                {{ getFieldValue(ex, 'muscle_group') || '—' }}
            </td>
        </ng-container>

        <!-- Equipment Type Column -->
        <ng-container matColumnDef="equipment_type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Equipo</th>
            <td mat-cell *matCellDef="let ex" matTooltip="{{ getFieldValue(ex, 'equipment_type') || '' }}">
                {{ getFieldValue(ex, 'equipment_type') || '—' }}
            </td>
        </ng-container>

        <!-- Category Column -->
        <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
            <td mat-cell *matCellDef="let ex" matTooltip="{{ getFieldValue(ex, 'category') || '' }}">
                {{ getFieldValue(ex, 'category') || '—' }}
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <!-- Paginator -->
    <mat-paginator [pageSize]="25" [pageSizeOptions]="[25, 50]" showFirstLastButtons (page)="onPageChange()"></mat-paginator>
</div>
